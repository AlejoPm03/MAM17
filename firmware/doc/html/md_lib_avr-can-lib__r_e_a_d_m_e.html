<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chopper PMDC 2017: Universelle CAN Blibiothek (avr-can-lib)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Chopper PMDC 2017
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_lib_avr-can-lib__r_e_a_d_m_e.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Universelle CAN Blibiothek (avr-can-lib) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Universelle CAN Bibliothek für AVRs. Unterstütz werden AT90CAN, MCP2515 und SJA1000. Siehe dazu auch den Artikel <a href="http://www.kreatives-chaos.com/artikel/universelle-can-bibliothek">Universelle CAN Bibliothek</a> auf <a href="http://www.kreatives-chaos.com">kreatives-chaos.com</a>.</p>
<h2>Motivation </h2>
<p>Die Bibliothek ist für den <a href="http://www.roboterclub.rwth-aachen.de/">Roboterclub Aachen e.V.</a> entstanden. Vor zwei Jahren stand ein Wechsel des internen Bussystems an, die Wahl fiel dabei auf den CAN-Bus, da er eigentlich ideal für diese Anwendung ist. Es gab nur leider keine Open-Source Bibliotheken für die Ansteuerung der gebräuchlichsten CAN-Controller, so dass selbst schreiben angesagt war.</p>
<p>Die Bibliothek ist jetzt seit einiger Zeit in Gebrauch und wurde dabei vom <a href="http://www.kreatives-chaos.com/artikel/ansteuerung-eines-mcp2515">MCP2515</a> auf die anderen CAN-Controller erweitert.</p>
<h2>Features </h2>
<ul>
<li>Unterstützung des MCP2515</li>
<li>Unterstützung des SJA1000 (für AVRs mit oder ohne externem Bus-Interface!)</li>
<li>Unterstützung der AT90CAN-Reihe</li>
<li>Aufbau als Library, damit werden nur die benötigen Funktionen verwendet</li>
<li>geringer Resourcen-Verbrauch</li>
</ul>
<p>Die Bibliothek braucht ca. 1500 Byte Flash mit allen Funktionen. Verwendet man keine dynamischen Filter sind es 370 Byte weniger.</p>
<h3>Filter</h3>
<p>Für den MCP2515 gibt es zwei Arten die Masken und Filter anzusprechen, zum einen "statisch" mit einer Liste die zur Compile-Zeit angelegt wird oder "dynamisch" während der Laufzeit, dann aber mit größerem Flash Verbrauch.</p>
<p>Die AT90CANxxx kennen nur die dynamischen Filter.</p>
<p>Gleiches gilt für den SJA1000. Dieser bietet zwar theoretisch zwei Filter für Standard-Nachrichten bzw. einen für Extended-Nachrichten, in der Praxis sind diese aber mehr oder weniger unbrauchbar.</p>
<h2>Einbinden ins eigene Programm </h2>
<p>Zuerst einmal muss die Bibliothek erstellt werden: Dazu ändert man im <code>src/</code>-Ordner die Datei 'config.h' für seine Konfiguration ab und stellt im Makefile den verwenden AVR-Typ ein.</p>
<p>Dann kann die Bibliothek gebaut werden: </p><pre class="fragment">$ make lib
</pre><p>Wer WinAVR verwendet kann auch einfach im Programmers Notepad eine der Dateien aus dem <code>src/</code>-Ordner öffnen und dann "Tools &gt; [WinAVR] Make All" auswählen.</p>
<p>Jetzt sollte eine Datei 'libcan.a' entstanden sein. Zusammen mit 'can.h' und 'config.h' können diese Dateien jetzt in das eigene Projektverzeichnis kopiert werden.</p>
<p>Um die Funktionen wirklich nutzten zu können muss nur noch den Linker mitgeteilt werden, dass er die Bibliothek einbinden soll. Bei dem Standard-WinAVR-Makefile muss dazu die folgende Zeile hinzugefügt werden (um Zeile 266ff): </p><pre class="fragment">...
LDFLAGS += $(patsubst %,-L%,$(EXTRALIBDIRS))
LDFLAGS += $(PRINTF_LIB) $(SCANF_LIB) $(MATH_LIB)

LDFLAGS += -L. -lcan        # hinzufügen
</pre><p>Der Linker sucht dann automatisch im aktuellen Verzeichnis nach der Datei libcan.a und fügt die benötigten Funktionen (und nur die) in den Quellcode ein.</p>
<h4>Hinweise zur Benutzung der Ports:</h4>
<p>Da bei AVR's die I/O Pins mehrfach belegt sind, beachten Sie bitte unbedingt die Fusebits des von Ihnen eingesetzten AVR's, konkret am Beispiel ATmega32:</p>
<p>Port C teilt sich Bit 2 - 5 mit der JTAG Schnittstelle, die ab Werk aktiviert ist - deaktivieren! Port D teilt sich Bit 0 und 1 mit der seriellen Schnittstelle. Wenn Sie alle Pins verwenden wollen, dürfen Sie den MAX 232 nicht bestücken.</p>
<p>Wenn man dann noch die Quelle der Oszillatorfrequenz richtig setzt, kann man fröhlich CANnen:</p>
<p>ATmega32 Low Fuse: 0xEF (External Crystal) ATmega32 High Fuse: 0xD9 (JTAG Disabled)</p>
<h2>Testprogram </h2>
<p>Ein Program was einfach eine Nachricht per CAN verschickt könnte folgendermaßen aussehen: </p><pre class="fragment">int main(void)
{
    // initialisieren des MCP2515
    can_init(BITRATE_125_KBPS);

    // erzeuge eine Testnachricht
    can_t msg;

    msg.id = 0x123456;
    msg.flags.rtr = 0;
    msg.flags.extended = 1;

    msg.length = 4;
    msg.data[0] = 0xde;
    msg.data[1] = 0xad;
    msg.data[2] = 0xbe;
    msg.data[3] = 0xef;

    // Nachricht verschicken
    can_send_message(&amp;msg);

    while (1) {

    }
}
</pre><h2>Lizenz </h2>
<p>Die Bibliothek steht unter einer <a href="http://de.wikipedia.org/wiki/BSD-Lizenz">BSD-Lizenz</a> und darf damit frei verwendet werden.</p>
<p>Wenn jemand Änderungen vornimmt würde ich bitten mir oder jemand anderem aus dem <a href="http://www.roboterclub.rwth-aachen.de/">Roboterclub</a> diese zukommen zu lassen, damit wir sie gegebenenfalls in die Software einbauen können, so dass dann alle etwas davon haben. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
